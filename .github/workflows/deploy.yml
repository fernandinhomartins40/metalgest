name: Deploy MetalGest - Node.js + SQLite - VPS 72.60.10.112

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Completo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Preparar arquivos para deploy
        run: |
          # Apenas verificar estrutura - build serÃ¡ feito no Docker
          echo "ğŸ“ Verificando estrutura do projeto:"
          ls -la
          echo "âœ… Frontend source:"
          ls -la apps/web/
          echo "âœ… Backend source:"
          ls -la backend/

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy to VPS
        env:
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          # Configurar variÃ¡veis
          VPS_HOST="72.60.10.112"
          VPS_USER="root"
          DEPLOY_PATH="/var/www/metalgest"
          
          echo "ğŸš€ Iniciando deploy para VPS ${VPS_HOST}:3010"
          
          # FunÃ§Ã£o para executar comandos SSH
          ssh_exec() {
            sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=10 "$VPS_USER@$VPS_HOST" "$1"
          }
          
          # FunÃ§Ã£o para copiar arquivos
          scp_copy() {
            sshpass -p "$VPS_PASSWORD" scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30 -r "$1" "$VPS_USER@$VPS_HOST:$2"
          }
          
          # 1. Preparar diretÃ³rios na VPS
          echo "ğŸ“ Preparando diretÃ³rios na VPS..."
          if ! ssh_exec "mkdir -p $DEPLOY_PATH && cd $DEPLOY_PATH && rm -rf * .* 2>/dev/null || true && mkdir -p frontend backend nginx"; then
            echo "âŒ Erro ao preparar diretÃ³rios"
            exit 1
          fi
          echo "âœ… DiretÃ³rios preparados"
          
          # 2. Copiar todos os arquivos de uma vez
          echo "ğŸ“¦ Criando pacote para deploy..."
          tar -czf deploy.tar.gz \
            docker-compose.yml \
            Dockerfile.frontend \
            Dockerfile.backend \
            nginx/ \
            apps/ \
            backend/ \
            package.json \
            package-lock.json 2>/dev/null || tar -czf deploy.tar.gz \
            docker-compose.yml \
            Dockerfile.frontend \
            Dockerfile.backend \
            nginx/ \
            apps/ \
            backend/ \
            package.json
          
          echo "ğŸ“¦ Enviando pacote para VPS..."
          if ! scp_copy "deploy.tar.gz" "$DEPLOY_PATH/"; then
            echo "âŒ Erro ao enviar pacote"
            exit 1
          fi
          
          echo "ğŸ“¦ Extraindo pacote na VPS..."
          ssh_exec "cd $DEPLOY_PATH && tar -xzf deploy.tar.gz && rm deploy.tar.gz"
          
          echo "âœ… Arquivos copiados com sucesso"
          
          # 3. Instalar Docker e Docker Compose na VPS (se necessÃ¡rio)
          echo "ğŸ“¦ Verificando Docker na VPS..."
          ssh_exec "
            if ! command -v docker &> /dev/null; then
              echo 'ğŸ“¥ Instalando Docker...'
              apt-get update -y
              apt-get install -y ca-certificates curl gnupg lsb-release
              mkdir -p /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo \"deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable\" | tee /etc/apt/sources.list.d/docker.list > /dev/null
              apt-get update -y
              apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
              systemctl enable docker
              systemctl start docker
            fi
            
            if ! command -v docker-compose &> /dev/null; then
              echo 'ğŸ“¥ Instalando Docker Compose...'
              curl -L \"https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
            fi
            
            echo 'âœ… Ferramentas instaladas:'
            docker --version
            docker-compose --version
          "
          
          # 4. Preparar ambiente
          echo "ğŸ“ Criando arquivos de ambiente..."
          ssh_exec "cd $DEPLOY_PATH && cat > .env << 'EOF'
          NODE_ENV=production
          JWT_SECRET=metalgest-jwt-secret-production-$(date +%s)
          REFRESH_TOKEN_SECRET=metalgest-refresh-secret-production-$(date +%s)
          FRONTEND_URL=http://72.60.10.112:3010
          VITE_API_URL=http://72.60.10.112:3010/api
          EOF"
          
          # 5. Parar containers existentes
          echo "ğŸ›‘ Parando containers existentes..."
          ssh_exec "cd $DEPLOY_PATH && docker-compose down --remove-orphans 2>/dev/null || true"
          
          # 6. Fazer backup
          echo "ğŸ’¾ Criando backup..."
          ssh_exec "
            TIMESTAMP=\$(date +\"%Y%m%d_%H%M%S\")
            mkdir -p /var/www/metalgest-backup
            if [ -d \"/var/www/metalgest-backup/deploy-current\" ]; then
              mv /var/www/metalgest-backup/deploy-current /var/www/metalgest-backup/deploy-\$TIMESTAMP
            fi
            cp -r $DEPLOY_PATH /var/www/metalgest-backup/deploy-current
          "
          
          # 7. Build containers com cache
          echo "ğŸ”§ Construindo containers..."
          ssh_exec "cd $DEPLOY_PATH && docker-compose build"
          
          # 8. Iniciar containers
          echo "ğŸš€ Iniciando containers..."
          ssh_exec "cd $DEPLOY_PATH && docker-compose up -d"
          
          # 9. Aguardar containers (tempo reduzido)
          echo "â³ Aguardando containers..."
          ssh_exec "
            for i in {1..30}; do
              if curl -s -f http://localhost:3010/api/health >/dev/null 2>&1; then
                echo \"âœ… AplicaÃ§Ã£o pronta apÃ³s \$i tentativas\"
                break
              fi
              echo \"Tentativa \$i/30...\"
              sleep 3
            done
          "
          
          # 10. Verificar status
          echo "ğŸ“‹ Verificando status dos containers..."
          ssh_exec "cd $DEPLOY_PATH && docker-compose ps"
          
          # 11. Teste final
          echo "ğŸ§ª Testando aplicaÃ§Ã£o..."
          ssh_exec "
            if curl -s -f http://localhost:3010/api/health >/dev/null 2>&1; then
              echo \"âœ… AplicaÃ§Ã£o funcionando em http://72.60.10.112:3010\"
              echo \"âœ… API health check: OK\"
              echo \"ğŸ‰ DEPLOY CONCLUÃDO COM SUCESSO!\"
              echo \"ğŸŒ AplicaÃ§Ã£o disponÃ­vel em: http://72.60.10.112:3010\"
              echo \"ğŸ“Š Health check: http://72.60.10.112:3010/api/health\"
            else
              echo \"âŒ Falha no health check\"
              docker-compose logs --tail=20
              exit 1
            fi
          "
          
          echo "âœ… Deploy finalizado com sucesso!"