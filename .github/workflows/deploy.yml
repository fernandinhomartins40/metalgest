name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build T3 Stack Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm run db:generate

      - name: Build Frontend
        run: |
          # Set production API URL for build
          echo "NEXT_PUBLIC_API_URL=https://metalgest.com.br" > apps/web/.env.production
          npm run build:web

      - name: Create .env file for Backend
        run: |
          echo "DATABASE_URL=\"postgresql://dummy:dummy@localhost:5432/dummy\"" > apps/server/.env
          echo "NEXTAUTH_SECRET=\"dummy-secret\"" >> apps/server/.env
          echo "NEXTAUTH_URL=\"http://localhost:3000\"" >> apps/server/.env
          echo "JWT_SECRET=\"dummy-jwt-secret\"" >> apps/server/.env

      - name: Build Backend
        run: |
          npm run build:server || (echo "âŒ ERRO: Falha ao buildar o backend" && exit 1)
          if [ ! -d "apps/server/.next" ]; then
            echo "âŒ ERRO: Backend nÃ£o gerou a pasta .next corretamente!"
            exit 1
          fi

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: apps/web/dist

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: apps/server/.next

      - name: Upload Packages
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: packages

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: apps/web/dist

      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: apps/server/.next

      - name: Download Packages
        uses: actions/download-artifact@v4
        with:
          name: packages
          path: packages

      - name: Checkout code for deploy files
        uses: actions/checkout@v4
        with:
          path: source
          
      - name: Create VPS directories
        uses: appleboy/ssh-action@master
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            mkdir -p /var/www/metalgest
            mkdir -p /var/www/metalgest/backend
            mkdir -p /var/www/metalgest/nginx
            
      - name: Transfer files to VPS
        uses: appleboy/scp-action@master
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          source: "source/Dockerfile.backend,source/Dockerfile.frontend,source/docker-compose.yml,source/entrypoint.sh,source/rollback.sh,source/package.json,source/turbo.json,source/apps,source/packages,source/nginx,apps/web/dist,apps/server/.next,packages"
          target: "/var/www/metalgest"
          strip_components: 1
          debug: true
          
      - name: Ensure T3 Stack structure
        uses: appleboy/ssh-action@master
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /var/www/metalgest
            
            # Verifica e cria estrutura do T3 Stack se necessÃ¡rio
            echo "=== Verificando estrutura T3 Stack ==="
            echo "ConteÃºdo da pasta atual:"
            ls -la
            echo ""
            echo "Estrutura de diretÃ³rios:"
            find . -type d -name "apps" -o -name "packages" -o -name ".next" 2>/dev/null || echo "Nenhum diretÃ³rio T3 Stack encontrado"
            echo ""
            
            # Verificar se a estrutura do T3 Stack estÃ¡ correta
            if [ ! -d "apps" ]; then
              echo "âŒ ERRO: DiretÃ³rio apps nÃ£o encontrado!"
              echo "Estrutura T3 Stack nÃ£o estÃ¡ correta."
              exit 1
            fi
            
            if [ ! -d "packages" ]; then
              echo "âŒ ERRO: DiretÃ³rio packages nÃ£o encontrado!"
              echo "Estrutura T3 Stack nÃ£o estÃ¡ correta."
              exit 1
            fi
            
            # Verificar se o backend foi buildado
            if [ ! -d "apps/server/.next" ]; then
              echo "âŒ ERRO: Backend .next nÃ£o encontrado!"
              echo "O deploy nÃ£o pode continuar sem o backend buildado."
              exit 1
            fi
            
            # Verificar se o frontend foi buildado
            if [ ! -d "apps/web/dist" ]; then
              echo "âŒ ERRO: Frontend dist nÃ£o encontrado!"
              echo "O deploy nÃ£o pode continuar sem o frontend buildado."
              exit 1
            fi
            
            echo ""
            echo "=== Estrutura T3 Stack verificada ==="
            echo "Apps structure:"
            ls -la apps/ 2>/dev/null || echo "âŒ Apps folder not found"
            echo "Backend .next contents:"
            ls -la apps/server/.next/ 2>/dev/null || echo "âŒ Backend .next not found"
            echo "Frontend dist contents:"
            ls -la apps/web/dist/ 2>/dev/null || echo "âŒ Frontend dist not found"
            echo "Packages structure:"
            ls -la packages/ 2>/dev/null || echo "âŒ Packages folder not found"
            echo ""
            
            echo "âœ… Estrutura T3 Stack validada com sucesso!"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /var/www/metalgest
            
            # === Install Docker and Docker Compose ===
            echo "=== Installing Docker and Docker Compose ==="
            
            # Update system
            apt-get update -y
            
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              systemctl enable docker
              systemctl start docker
              rm get-docker.sh
            else
              echo "âœ… Docker already installed"
            fi
            
            # Install Docker Compose if not present
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing Docker Compose..."
              curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
            else
              echo "âœ… Docker Compose already installed"
            fi
            
            # Verify installations
            docker --version
            docker-compose --version
            
            # === Configure Environment Variables ===
            echo "=== Configuring Environment ==="
            
            # Set default values if secrets are not defined
            DB_NAME="${{ secrets.DB_NAME }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
            JWT_SECRET="${{ secrets.JWT_SECRET }}"
            
            # Use defaults if secrets are empty
            DB_NAME=${DB_NAME:-"metalgest"}
            DB_USER=${DB_USER:-"postgres"}
            DB_PASSWORD=${DB_PASSWORD:-"postgres123"}
            NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-"metalgest-secret-key-production-2024"}
            JWT_SECRET=${JWT_SECRET:-"metalgest-jwt-secret-production-2024"}
            
            # Create environment file
            echo "Creating .env file..."
            cat > .env << EOF
            NODE_ENV=production
            DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}
            NEXTAUTH_URL=https://metalgest.com.br
            NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
            JWT_SECRET=${JWT_SECRET}
            POSTGRES_DB=${DB_NAME}
            POSTGRES_USER=${DB_USER}
            POSTGRES_PASSWORD=${DB_PASSWORD}
            NEXT_PUBLIC_API_URL=https://metalgest.com.br
            EOF
            
            echo "âœ… Environment file created successfully"
            echo "Database config: ${DB_USER}@db:5432/${DB_NAME}"
            
            # === Setup Nginx Configuration ===
            echo "=== Setting up Nginx ==="
            echo "âœ… Using nginx/default.conf configuration"
            
            # === Clean Up Previous Deployment ===
            echo "=== Cleaning up previous deployment ==="
            
            # Stop and remove containers
            docker-compose down -v 2>/dev/null || echo "No containers to stop"
            
            # Remove unused images and volumes
            docker system prune -f 2>/dev/null || echo "Docker cleanup completed"
            
            # Stop system nginx if running
            systemctl stop nginx 2>/dev/null || echo "System nginx not running"
            
            # === Deploy Application ===
            # === Create backup before deploy ===
            echo "=== Creating backup before deploy ==="
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            mkdir -p /var/www/metalgest-backup
            if [ -d "/var/www/metalgest" ]; then
              cp -r /var/www/metalgest /var/www/metalgest-backup/deploy-$TIMESTAMP
              echo "âœ… Backup created: /var/www/metalgest-backup/deploy-$TIMESTAMP"
            fi
            
            # Make rollback script executable
            chmod +x /var/www/metalgest/rollback.sh
            
            echo "=== Deploying application ==="
            
            # Build and start containers (database first)
            echo "Starting database..."
            docker-compose up -d db
            
            # Wait for database using docker-compose health check
            echo "=== Waiting for database ==="
            for i in {1..30}; do
              if docker-compose ps db | grep -q "healthy"; then
                echo "âœ… Database is healthy after ${i} attempts"
                break
              fi
              echo "Database not healthy yet, attempt ${i}/30..."
              sleep 3
            done
            
            # Verify database is really ready
            if ! docker-compose ps db | grep -q "healthy"; then
              echo "âŒ Database failed to start, checking logs..."
              docker-compose logs db --tail=30
              exit 1
            fi
            
            # Now start backend (Next.js server)
            echo "Starting backend (Next.js server)..."
            docker-compose up -d --build backend
            
            # === Setup Database (handled by entrypoint) ===
            echo "=== Database setup serÃ¡ gerenciado pelo backend startup ==="
            
            # Wait for backend to be healthy with more robust checking
            echo "=== Waiting for backend to be healthy ==="
            BACKEND_HEALTHY=false
            for i in {1..90}; do
              # Check if backend container is running first
              if docker-compose ps backend | grep -q "Up"; then
                echo "Backend container is running..."
                
                # Check health status
                if docker-compose ps backend | grep -q "healthy"; then
                  echo "âœ… Backend is healthy after ${i} attempts"
                  BACKEND_HEALTHY=true
                  break
                fi
                
                # Try direct API call as backup health check
                if curl -s -f http://localhost:3000/api/health >/dev/null 2>&1; then
                  echo "âœ… Backend responds to health check (direct) after ${i} attempts"
                  BACKEND_HEALTHY=true
                  break
                fi
              else
                echo "Backend container not running yet..."
              fi
              
              echo "Backend not healthy yet, attempt ${i}/90..."
              sleep 7
            done
            
            if [ "$BACKEND_HEALTHY" = false ]; then
              echo "âŒ Backend failed to become healthy, checking logs..."
              echo "Backend logs:"
              docker-compose logs backend --tail=30
              echo "Database logs:"
              docker-compose logs db --tail=10
              # Continue anyway to see nginx behavior
            fi
            
            # Start frontend
            echo "Starting frontend..."
            docker-compose up -d --build frontend
            
            # Finally start nginx
            echo "Starting nginx..."
            docker-compose up -d nginx
            
            # === Final Health Checks ===
            echo "=== Final Health Checks ==="
            
            # Wait a bit for nginx to be ready
            sleep 10
            
            # Show final container status
            echo "Container Status:"
            docker-compose ps
            
            # Test application through nginx
            echo "=== Testing Application ==="
            
            # Try multiple endpoints to ensure everything works
            echo "Testing application endpoints..."
            
            # Test direct backend health
            if curl -s -f http://localhost:3000/api/health 2>/dev/null; then
              echo "âœ… Direct Backend Health Check - OK"
            else
              echo "âš ï¸ Direct Backend Health Check - FAILED"
            fi
            
            # Test through nginx proxy
            if curl -s -f http://localhost:80/api/health 2>/dev/null; then
              echo "âœ… Nginx Proxy API Health Check - OK"
            else
              echo "âŒ Nginx Proxy API Health Check - FAILED"
              echo "This indicates nginx reverse proxy issues"
              echo "Backend logs:"
              docker-compose logs backend --tail=10
              echo "Frontend logs:"
              docker-compose logs frontend --tail=10
              echo "Nginx logs:"
              docker-compose logs nginx --tail=10
              
              # Don't exit immediately, show more diagnostics
              echo "=== Diagnostic Information ==="
              echo "Container status:"
              docker-compose ps
              echo "Nginx config test:"
              docker-compose exec nginx nginx -t 2>/dev/null || echo "Nginx config test failed"
              
              # Only exit if both backend and nginx are failing
              if ! curl -s -f http://localhost:3000/api/health 2>/dev/null; then
                echo "âŒ Critical: Both backend and nginx proxy are failing"
                echo "ğŸ”„ Executing rollback..."
                bash /var/www/metalgest/rollback.sh
                exit 1
              else
                echo "âš ï¸ Backend works directly but nginx proxy fails - continuing deployment"
              fi
            fi
            
            # Final success message
            echo ""
            echo "ğŸ‰ DEPLOY SUCCESSFUL!"
            echo "ğŸŒ Application is available at: http://31.97.85.98"
            echo "ğŸ“Š API endpoint: http://31.97.85.98/api/health"
            echo ""
            echo "ğŸ“‹ Services Status:"
            docker-compose ps --format "table {{.Name}}\t{{.State}}\t{{.Status}}"
