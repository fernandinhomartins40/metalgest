name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build Frontend
        run: |
          npm install
          npm run build

      - name: Build Backend
        run: |
          cd backend
          npm install
          npm run build
          # Verificar se o build foi criado
          echo "Verificando backend/dist:"
          ls -la dist/ || echo "ERRO: Backend dist nÃ£o foi criado!"

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: backend/dist

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: backend/dist

      - name: Checkout code for deploy files
        uses: actions/checkout@v4
        with:
          path: source
          
      - name: Create VPS directories
        uses: appleboy/ssh-action@master
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            mkdir -p /var/www/metalgest
            mkdir -p /var/www/metalgest/backend
            mkdir -p /var/www/metalgest/nginx
            
      - name: Transfer files to VPS
        uses: appleboy/scp-action@master
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          source: "source/Dockerfile,source/docker-compose.yml,source/entrypoint.sh,source/rollback.sh,source/backend/package.json,source/backend/prisma,source/nginx,frontend/dist,backend/dist"
          target: "/var/www/metalgest"
          strip_components: 1
          debug: true
          
      - name: Ensure backend structure
        uses: appleboy/ssh-action@master
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /var/www/metalgest
            
            # Verifica e cria estrutura do backend se necessÃ¡rio
            echo "=== Verificando estrutura inicial ==="
            echo "ConteÃºdo da pasta atual:"
            ls -la
            echo ""
            echo "Estrutura de diretÃ³rios:"
            find . -type d -name "*dist*" -o -name "backend" -o -name "frontend" 2>/dev/null || echo "Nenhum diretÃ³rio dist/backend/frontend encontrado"
            echo ""
            
            # Criar estrutura backend se nÃ£o existir
            mkdir -p backend
            
            # Verifica se backend/dist existe
            if [ ! -d "backend/dist" ]; then
              echo "âš ï¸ backend/dist nÃ£o encontrado, verificando alternativas..."
              
              # Procurar por arquivos dist em qualquer lugar
              if [ -d "dist" ]; then
                echo "âœ“ Encontrado dist na raiz, movendo para backend/"
                mv dist backend/
              elif find . -name "*.js" -path "*/dist/*" | head -1 | grep -q .; then
                echo "âœ“ Encontrados arquivos JS compilados, organizando estrutura..."
                # Mover todos os arquivos dist encontrados para backend/dist
                find . -name "dist" -type d | while read distdir; do
                  if [ "$distdir" != "./backend/dist" ]; then
                    echo "Movendo $distdir para backend/"
                    mkdir -p backend/dist
                    cp -r "$distdir"/* backend/dist/ 2>/dev/null || true
                  fi
                done
              else
                echo "âŒ ERRO: Nenhum arquivo compilado encontrado!"
                echo "Listando todos os arquivos JavaScript encontrados:"
                find . -name "*.js" | head -10
                exit 1
              fi
            fi
            
            # Verifica se frontend/dist existe e move para raiz
            if [ ! -d "dist" ] && [ -d "frontend/dist" ]; then
              echo "âœ“ Movendo frontend/dist para raiz"
              mv frontend/dist .
            fi
            
            echo ""
            echo "=== Estrutura final verificada ==="
            echo "Backend structure:"
            ls -la backend/ 2>/dev/null || echo "âŒ Backend folder not found"
            echo "Backend dist contents:"
            ls -la backend/dist/ 2>/dev/null || echo "âŒ Backend dist not found"
            echo "Frontend dist (root):"
            ls -la dist/ 2>/dev/null || echo "âŒ Frontend dist not found"
            echo ""
            
            # VerificaÃ§Ã£o final obrigatÃ³ria
            if [ ! -f "backend/dist/index.js" ]; then
              echo "âŒ ERRO CRÃTICO: backend/dist/index.js nÃ£o encontrado!"
              echo "O deploy nÃ£o pode continuar sem o backend compilado."
              exit 1
            else
              echo "âœ… backend/dist/index.js encontrado - estrutura OK"
            fi

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: 31.97.85.98
          username: root
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /var/www/metalgest
            
            # === Install Docker and Docker Compose ===
            echo "=== Installing Docker and Docker Compose ==="
            
            # Update system
            apt-get update -y
            
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              systemctl enable docker
              systemctl start docker
              rm get-docker.sh
            else
              echo "âœ… Docker already installed"
            fi
            
            # Install Docker Compose if not present
            if ! command -v docker-compose &> /dev/null; then
              echo "Installing Docker Compose..."
              curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
            else
              echo "âœ… Docker Compose already installed"
            fi
            
            # Verify installations
            docker --version
            docker-compose --version
            
            # === Configure Environment Variables ===
            echo "=== Configuring Environment ==="
            
            # Set default values if secrets are not defined
            DB_NAME="${{ secrets.DB_NAME }}"
            DB_USER="${{ secrets.DB_USER }}"
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            JWT_SECRET="${{ secrets.JWT_SECRET }}"
            JWT_REFRESH_SECRET="${{ secrets.JWT_REFRESH_SECRET }}"
            
            # Use defaults if secrets are empty
            DB_NAME=${DB_NAME:-"metalgest"}
            DB_USER=${DB_USER:-"postgres"}
            DB_PASSWORD=${DB_PASSWORD:-"postgres123"}
            JWT_SECRET=${JWT_SECRET:-"your-super-secret-jwt-key-change-in-production"}
            JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET:-"your-super-secret-refresh-jwt-key-change-in-production"}
            
            # Create environment file
            echo "Creating .env file..."
            cat > .env << EOF
            NODE_ENV=production
            PORT=3001
            API_VERSION=v1
            JWT_SECRET=${JWT_SECRET}
            JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
            DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}
            CORS_ORIGIN=*
            POSTGRES_DB=${DB_NAME}
            POSTGRES_USER=${DB_USER}
            POSTGRES_PASSWORD=${DB_PASSWORD}
            ENCRYPTION_KEY=your-encryption-key-32-characters-long
            EMAIL_USER=noreply@metalgest.com
            EMAIL_PASS=dummy-password
            EMAIL_HOST=smtp.gmail.com
            EMAIL_PORT=587
            EMAIL_FROM=MetalGest <noreply@metalgest.com>
            ASAAS_API_KEY=dummy-key
            MERCADOPAGO_ACCESS_TOKEN=dummy-token
            EOF
            
            echo "âœ… Environment file created successfully"
            echo "Database config: ${DB_USER}@db:5432/${DB_NAME}"
            
            # === Setup Nginx Configuration ===
            echo "=== Setting up Nginx ==="
            echo "âœ… Using nginx/default.conf configuration"
            
            # === Clean Up Previous Deployment ===
            echo "=== Cleaning up previous deployment ==="
            
            # Stop and remove containers
            docker-compose down -v 2>/dev/null || echo "No containers to stop"
            
            # Remove unused images and volumes
            docker system prune -f 2>/dev/null || echo "Docker cleanup completed"
            
            # Stop system nginx if running
            systemctl stop nginx 2>/dev/null || echo "System nginx not running"
            
            # === Deploy Application ===
            # === Create backup before deploy ===
            echo "=== Creating backup before deploy ==="
            TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
            mkdir -p /var/www/metalgest-backup
            if [ -d "/var/www/metalgest" ]; then
              cp -r /var/www/metalgest /var/www/metalgest-backup/deploy-$TIMESTAMP
              echo "âœ… Backup created: /var/www/metalgest-backup/deploy-$TIMESTAMP"
            fi
            
            # Make rollback script executable
            chmod +x /var/www/metalgest/rollback.sh
            
            echo "=== Deploying application ==="
            
            # Build and start containers (database first)
            echo "Starting database..."
            docker-compose up -d db
            
            # Wait for database using docker-compose health check
            echo "=== Waiting for database ==="
            for i in {1..30}; do
              if docker-compose ps db | grep -q "healthy"; then
                echo "âœ… Database is healthy after ${i} attempts"
                break
              fi
              echo "Database not healthy yet, attempt ${i}/30..."
              sleep 3
            done
            
            # Verify database is really ready
            if ! docker-compose ps db | grep -q "healthy"; then
              echo "âŒ Database failed to start, checking logs..."
              docker-compose logs db --tail=30
              exit 1
            fi
            
            # Now start backend
            echo "Starting backend..."
            docker-compose up -d --build backend
            
            # === Setup Database (handled by entrypoint) ===
            echo "=== Database setup serÃ¡ gerenciado pelo entrypoint.sh ==="
            
            # Wait for backend to be healthy with more robust checking
            echo "=== Waiting for backend to be healthy ==="
            BACKEND_HEALTHY=false
            for i in {1..90}; do
              # Check if backend container is running first
              if docker-compose ps backend | grep -q "Up"; then
                echo "Backend container is running..."
                
                # Check health status
                if docker-compose ps backend | grep -q "healthy"; then
                  echo "âœ… Backend is healthy after ${i} attempts"
                  BACKEND_HEALTHY=true
                  break
                fi
                
                # Try direct API call as backup health check
                if curl -s -f http://localhost:3001/api/v1/health >/dev/null 2>&1; then
                  echo "âœ… Backend responds to health check (direct) after ${i} attempts"
                  BACKEND_HEALTHY=true
                  break
                fi
              else
                echo "Backend container not running yet..."
              fi
              
              echo "Backend not healthy yet, attempt ${i}/90..."
              sleep 7
            done
            
            if [ "$BACKEND_HEALTHY" = false ]; then
              echo "âŒ Backend failed to become healthy, checking logs..."
              echo "Backend logs:"
              docker-compose logs backend --tail=30
              echo "Database logs:"
              docker-compose logs db --tail=10
              # Continue anyway to see nginx behavior
            fi
            
            # Finally start nginx
            echo "Starting nginx..."
            docker-compose up -d nginx
            
            # === Final Health Checks ===
            echo "=== Final Health Checks ==="
            
            # Wait a bit for nginx to be ready
            sleep 10
            
            # Show final container status
            echo "Container Status:"
            docker-compose ps
            
            # Test application through nginx
            echo "=== Testing Application ==="
            
            # Try multiple endpoints to ensure everything works
            echo "Testing application endpoints..."
            
            # Test direct backend health
            if curl -s -f http://localhost:3001/api/v1/health 2>/dev/null; then
              echo "âœ… Direct Backend Health Check - OK"
            else
              echo "âš ï¸ Direct Backend Health Check - FAILED"
            fi
            
            # Test through nginx proxy
            if curl -s -f http://localhost:80/api/v1/health 2>/dev/null; then
              echo "âœ… Nginx Proxy API Health Check - OK"
            else
              echo "âŒ Nginx Proxy API Health Check - FAILED"
              echo "This indicates nginx reverse proxy issues"
              echo "Backend logs:"
              docker-compose logs backend --tail=10
              echo "Nginx logs:"
              docker-compose logs nginx --tail=10
              
              # Don't exit immediately, show more diagnostics
              echo "=== Diagnostic Information ==="
              echo "Container status:"
              docker-compose ps
              echo "Nginx config test:"
              docker-compose exec nginx nginx -t 2>/dev/null || echo "Nginx config test failed"
              
              # Only exit if both backend and nginx are failing
              if ! curl -s -f http://localhost:3001/api/v1/health 2>/dev/null; then
                echo "âŒ Critical: Both backend and nginx proxy are failing"
                echo "ğŸ”„ Executing rollback..."
                bash /var/www/metalgest/rollback.sh
                exit 1
              else
                echo "âš ï¸ Backend works directly but nginx proxy fails - continuing deployment"
              fi
            fi
            
            # Final success message
            echo ""
            echo "ğŸ‰ DEPLOY SUCCESSFUL!"
            echo "ğŸŒ Application is available at: http://31.97.85.98"
            echo "ğŸ“Š API endpoint: http://31.97.85.98/api/v1/health"
            echo ""
            echo "ğŸ“‹ Services Status:"
            docker-compose ps --format "table {{.Name}}\t{{.State}}\t{{.Status}}"
